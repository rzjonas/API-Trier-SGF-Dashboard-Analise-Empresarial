{% extends "layout.html" %}
{% block title %}Produto e Estoque{% endblock %}

{% block page_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/produtos_estoque.css') }}">
{% endblock %}

{% block content %}
<div id="mainContent" style="display: none;">
    <div class="card-row">
        <div class="card">
            <h3>Produtos Ativos</h3>
            <p id="card-produtos-ativos">0</p>
        </div>
        <div class="card">
            <h3>Produtos Sem Venda</h3>
            <p id="card-produtos-sem-venda">0</p>
            <span>No período selecionado</span>
        </div>
        <div class="card">
            <h3>Valor do Estoque (Custo)</h3>
            <p id="card-valor-estoque">R$ 0,00</p>
            <span>Baseado no custo médio</span>
        </div>
    </div>

    <div class="charts-grid">
        <div class="grafico-container">
            <h3>Níveis de Estoque</h3>
            <div class="niveis-estoque-container">
                <div class="nivel-item critico">
                    <div class="nivel-header">
                        <span class="nivel-titulo">Crítico</span>
                        <span id="card-estoque-critico" class="nivel-valor">0</span>
                    </div>
                    <span class="nivel-condicao">(&le; 2)</span>
                </div>
                <div class="nivel-item baixo">
                    <div class="nivel-header">
                        <span class="nivel-titulo">Baixo</span>
                        <span id="card-estoque-baixo" class="nivel-valor">0</span>
                    </div>
                    <span class="nivel-condicao">(&le; 5)</span>
                </div>
                <div class="nivel-item aceitavel">
                    <div class="nivel-header">
                        <span class="nivel-titulo">Aceitável</span>
                        <span id="card-estoque-aceitavel" class="nivel-valor">0</span>
                    </div>
                    <span class="nivel-condicao">(&gt; 5)</span>
                </div>
                <div class="nivel-item otimo">
                    <div class="nivel-header">
                        <span class="nivel-titulo">Ótimo</span>
                        <span id="card-estoque-otimo" class="nivel-valor">0</span>
                    </div>
                    <span class="nivel-condicao">(&gt; 10)</span>
                </div>
            </div>
        </div>

        <div class="grafico-container">
            <h3>Curva ABC de Produtos por Receita</h3>
            <canvas id="graficoCurvaABC"></canvas>
        </div>
        <div class="grafico-container">
            <h3>Top 10 Produtos (Receita)</h3>
            <canvas id="graficoTopReceita"></canvas>
        </div>
         <div class="grafico-container">
            <h3>Top 10 Produtos (Quantidade)</h3>
            <canvas id="graficoTopQtd"></canvas>
        </div>
    </div>

    <h2>Tabela de Análise de Produtos</h2>
    <div class="table-wrapper">
        <table id="tabela-analise-produtos">
            <thead>
                <tr>
                    <th title="Produto">Produto</th>
                    <th title="Qtd. Vendida">Qtd. Vendida</th>
                    <th title="Receita (R$)">Receita (R$)</th>
                    <th title="Custo Total (R$)">Custo Total (R$)</th>
                    <th title="Lucro Bruto (R$)">Lucro Bruto (R$)</th>
                    <th title="Margem (%)">Margem (%)</th>
                    <th title="Estoque Atual">Estoque Atual</th>
                    <th title="Giro (Simplificado)">
                        Giro (Simplificado)
                        <div class="tooltip-container">
                            <span class="info-icon">i</span>
                            <div class="tooltip-text">
                                Cálculo simplificado: Total de itens vendidos no período dividido pelo estoque atual. É uma métrica útil, mas uma aproximação.
                            </div>
                        </div>
                    </th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    <div class="paginacao-container" id="paginacaoContainerProdutos"></div>
</div>

<div id="emptyState" style="display: none;">
    <div class="icon">
        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z" fill="#5dade2"/>
        </svg>
    </div>
    <h2>Nenhum dado encontrado</h2>
    <p>Não há registros de vendas de produtos para gerar a análise com os filtros selecionados.</p>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const elements = {
        mainContent: document.getElementById('mainContent'),
        emptyState: document.getElementById('emptyState'),
        cardProdutosAtivos: document.getElementById('card-produtos-ativos'),
        cardProdutosSemVenda: document.getElementById('card-produtos-sem-venda'),
        cardValorEstoque: document.getElementById('card-valor-estoque'),
        cardEstoqueCritico: document.getElementById('card-estoque-critico'),
        cardEstoqueBaixo: document.getElementById('card-estoque-baixo'),
        cardEstoqueAceitavel: document.getElementById('card-estoque-aceitavel'),
        cardEstoqueOtimo: document.getElementById('card-estoque-otimo'),
        tabelaProdutosBody: document.querySelector('#tabela-analise-produtos tbody'),
        paginacaoContainer: document.getElementById('paginacaoContainerProdutos'),
        loadingOverlay: document.getElementById('loadingOverlay')
    };
    
    let chartABC, chartTopReceita, chartTopQtd;
    
    const ITENS_POR_PAGINA = 50;
    let paginaAtualProdutos = 1;
    let todosOsProdutos = [];

    const formatarMoeda = (valor) => {
        return (valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    };

    async function carregarDadosProdutos() {
        elements.loadingOverlay.style.display = 'flex';
        
        const dataInicio = document.getElementById('dataInicio').value;
        const dataFim = document.getElementById('dataFim').value;
        
        const url = `/api/dados-produtos-estoque?dataInicio=${dataInicio}&dataFim=${dataFim}`;

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Erro na requisição: ${response.statusText}`);
            
            const data = await response.json();

            if (!data || !data.tabela_produtos || data.tabela_produtos.length === 0) {
                elements.mainContent.style.display = 'none';
                elements.emptyState.style.display = 'flex';
            } else {
                elements.mainContent.style.display = 'block';
                elements.emptyState.style.display = 'none';

                atualizarCards(data.indicadores);
                renderizarGraficoABC(data.curva_abc);
                renderizarGraficosTop(data.graficos_top);
                
                todosOsProdutos = data.tabela_produtos;
                paginaAtualProdutos = 1;

                renderizarTabelaPaginada();
            }

        } catch (error) {
            console.error("Falha ao carregar dados de produtos e estoque:", error);
            elements.mainContent.style.display = 'none';
            elements.emptyState.style.display = 'flex';
        } finally {
            elements.loadingOverlay.style.display = 'none';
        }
    }

    function atualizarCards(indicadores) {
        elements.cardProdutosAtivos.textContent = (indicadores.produtos_ativos || 0).toLocaleString('pt-BR');
        elements.cardProdutosSemVenda.textContent = (indicadores.produtos_sem_venda || 0).toLocaleString('pt-BR');
        elements.cardValorEstoque.textContent = formatarMoeda(indicadores.valor_estoque_custo);
        elements.cardEstoqueCritico.textContent = (indicadores.estoque_critico || 0).toLocaleString('pt-BR');
        elements.cardEstoqueBaixo.textContent = (indicadores.estoque_baixo || 0).toLocaleString('pt-BR');
        elements.cardEstoqueAceitavel.textContent = (indicadores.estoque_aceitavel || 0).toLocaleString('pt-BR');
        elements.cardEstoqueOtimo.textContent = (indicadores.estoque_otimo || 0).toLocaleString('pt-BR');
    }

    function renderizarGraficoABC(dados) {
        const ctx = document.getElementById('graficoCurvaABC').getContext('2d');
        if (chartABC) chartABC.destroy();
        chartABC = new Chart(ctx, { type: 'doughnut', data: { labels: dados.labels, datasets: [{ label: 'Nº de Produtos por Categoria', data: dados.data, backgroundColor: ['#2ecc71', '#3498db', '#f1c40f'], hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } } });
    }

    function renderizarGraficosTop(dados) {
        const ctxReceita = document.getElementById('graficoTopReceita').getContext('2d');
        if (chartTopReceita) chartTopReceita.destroy();
        chartTopReceita = new Chart(ctxReceita, { type: 'bar', data: { labels: dados.top_receita.labels, datasets: [{ label: 'Receita (R$)', data: dados.top_receita.data, backgroundColor: '#1a3b5d', }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
        
        const ctxQtd = document.getElementById('graficoTopQtd').getContext('2d');
        if (chartTopQtd) chartTopQtd.destroy();
        chartTopQtd = new Chart(ctxQtd, { type: 'bar', data: { labels: dados.top_qtd.labels, datasets: [{ label: 'Quantidade Vendida', data: dados.top_qtd.data, backgroundColor: '#2c537e', }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
    }

    function renderizarTabelaPaginada() {
        const inicio = (paginaAtualProdutos - 1) * ITENS_POR_PAGINA;
        const fim = inicio + ITENS_POR_PAGINA;
        const dadosDaPagina = todosOsProdutos.slice(inicio, fim);

        renderizarTabelaProdutos(dadosDaPagina);
        elements.paginacaoContainer.innerHTML = criarControlesPaginacao();
    }

    function renderizarTabelaProdutos(produtosDaPagina) {
        if (produtosDaPagina.length === 0) {
            elements.tabelaProdutosBody.innerHTML = '<tr><td colspan="8">Nenhum dado de venda encontrado para o período.</td></tr>';
            return;
        }

        let tableHTML = '';
        produtosDaPagina.forEach(p => {
            tableHTML += `
                <tr>
                    <td>${p.nome}</td>
                    <td>${(p.qtd_vendida || 0).toLocaleString('pt-BR')}</td>
                    <td>${formatarMoeda(p.receita_gerada)}</td>
                    <td>${formatarMoeda(p.custo_total)}</td>
                    <td>${formatarMoeda(p.lucro_bruto)}</td>
                    <td>${(p.margem_percentual || 0).toFixed(2)}%</td>
                    <td>${(p.quantidadeEstoque || 0).toLocaleString('pt-BR')}</td>
                    <td>${(p.giro_estoque || 0).toFixed(2)}</td>
                </tr>
            `;
        });
        
        elements.tabelaProdutosBody.innerHTML = tableHTML;
    }

    function criarControlesPaginacao() {
        const totalPaginas = Math.ceil(todosOsProdutos.length / ITENS_POR_PAGINA);
        if (totalPaginas <= 1) return '';

        let html = `<button class="paginacao-btn" data-pagina="${paginaAtualProdutos - 1}" ${paginaAtualProdutos === 1 ? 'disabled' : ''}>&laquo; Anterior</button>`;
        for (let i = 1; i <= totalPaginas; i++) {
             if (i === 1 || i === totalPaginas || (i >= paginaAtualProdutos - 2 && i <= paginaAtualProdutos + 2)) {
                html += `<button class="paginacao-btn ${i === paginaAtualProdutos ? 'active' : ''}" data-pagina="${i}">${i}</button>`;
             } else if (i === paginaAtualProdutos - 3 || i === paginaAtualProdutos + 3) {
                html += `<span>...</span>`;
             }
        }
        html += `<button class="paginacao-btn" data-pagina="${paginaAtualProdutos + 1}" ${paginaAtualProdutos === totalPaginas ? 'disabled' : ''}>Próximo &raquo;</button>`;
        return html;
    }

    function handlePaginacaoClick(event) {
        const target = event.target.closest('.paginacao-btn');
        if (!target || target.disabled) return;

        paginaAtualProdutos = parseInt(target.dataset.pagina, 10);
        renderizarTabelaPaginada();
    }
    
    elements.paginacaoContainer.addEventListener('click', handlePaginacaoClick);

    carregarDadosProdutos();
});
</script>
{% endblock %}