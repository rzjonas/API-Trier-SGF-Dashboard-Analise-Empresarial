{% extends "layout.html" %}
{% block title %}Produto e Estoque{% endblock %}

{% block page_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/produtos_estoque.css') }}">
{% endblock %}

{% block content %}
<div id="mainContent" style="display: none;">
    <div class="card-row">
        <div class="card">
            <h3>Produtos Ativos</h3>
            <p id="card-produtos-ativos">0</p>
        </div>
        <div class="card">
            <h3>Produtos Sem Venda</h3>
            <p id="card-produtos-sem-venda">0</p>
            <span>No período selecionado</span>
        </div>
        <div class="card">
            <h3>Valor do Estoque (Custo)</h3>
            <p id="card-valor-estoque">R$ 0,00</p>
            <span>Baseado no custo médio</span>
        </div>
    </div>

    <div class="charts-grid">
        <div class="grafico-container">
            <h3>Níveis de Estoque</h3>
            <div class="niveis-estoque-container">
                <div class="nivel-item critico">
                    <div class="nivel-header">
                        <span class="nivel-titulo">Crítico</span>
                        <span id="card-estoque-critico" class="nivel-valor">0</span>
                    </div>
                    <span class="nivel-condicao">(&le; 2)</span>
                </div>
                <div class="nivel-item baixo">
                    <div class="nivel-header">
                        <span class="nivel-titulo">Baixo</span>
                        <span id="card-estoque-baixo" class="nivel-valor">0</span>
                    </div>
                    <span class="nivel-condicao">(&le; 5)</span>
                </div>
                <div class="nivel-item aceitavel">
                    <div class="nivel-header">
                        <span class="nivel-titulo">Aceitável</span>
                        <span id="card-estoque-aceitavel" class="nivel-valor">0</span>
                    </div>
                    <span class="nivel-condicao">(&gt; 5)</span>
                </div>
                <div class="nivel-item otimo">
                    <div class="nivel-header">
                        <span class="nivel-titulo">Ótimo</span>
                        <span id="card-estoque-otimo" class="nivel-valor">0</span>
                    </div>
                    <span class="nivel-condicao">(&gt; 10)</span>
                </div>
            </div>
        </div>

        <div class="grafico-container">
            <h3>Curva ABC de Produtos por Receita</h3>
            <canvas id="graficoCurvaABC"></canvas>
        </div>
        <div class="grafico-container">
            <h3>Top 10 Produtos (Receita)</h3>
            <canvas id="graficoTopReceita"></canvas>
        </div>
         <div class="grafico-container">
            <h3>Top 10 Produtos (Quantidade)</h3>
            <canvas id="graficoTopQtd"></canvas>
        </div>
    </div>

    <h2>Tabela de Análise de Produtos Vendidos</h2>
    <div class="table-wrapper">
        <table id="tabela-analise-produtos">
            <thead>
                <tr>
                    <th title="Produto">Produto</th>
                    <th title="Qtd. Vendida">Qtd. Vendida</th>
                    <th title="Receita (R$)">Receita (R$)</th>
                    <th title="Custo Total (R$)">Custo Total (R$)</th>
                    <th title="Lucro Bruto (R$)">Lucro Bruto (R$)</th>
                    <th title="Margem (%)">Margem (%)</th>
                    <th title="Estoque Atual">Estoque Atual</th>
                    <th title="Giro (Simplificado)">
                        Giro (Simplificado)
                        <div class="tooltip-container">
                            <span class="info-icon">i</span>
                            <div class="tooltip-text">
                                Cálculo simplificado: Total de itens vendidos no período dividido pelo estoque atual. É uma métrica útil, mas uma aproximação.
                            </div>
                        </div>
                    </th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    <div class="paginacao-container" id="paginacaoContainerProdutos"></div>
</div>

<div id="emptyState" style="display: none;">
    <div class="icon">
        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z" fill="#5dade2"/>
        </svg>
    </div>
    <h2>Nenhum dado encontrado</h2>
    <p>Não há registros de vendas de produtos para gerar a análise com os filtros selecionados.</p>
</div>
{% endblock %}

{% block scripts %}
<script>
// Executa o script quando o DOM estiver completamente carregado.
document.addEventListener('DOMContentLoaded', () => {
    
    // --- REFERÊNCIAS AOS ELEMENTOS DO DOM ---
    // Agrupa todas as referências a elementos HTML em um único objeto para fácil acesso.
    const elements = {
        mainContent: document.getElementById('mainContent'),
        emptyState: document.getElementById('emptyState'),
        cardProdutosAtivos: document.getElementById('card-produtos-ativos'),
        cardProdutosSemVenda: document.getElementById('card-produtos-sem-venda'),
        cardValorEstoque: document.getElementById('card-valor-estoque'),
        cardEstoqueCritico: document.getElementById('card-estoque-critico'),
        cardEstoqueBaixo: document.getElementById('card-estoque-baixo'),
        cardEstoqueAceitavel: document.getElementById('card-estoque-aceitavel'),
        cardEstoqueOtimo: document.getElementById('card-estoque-otimo'),
        tabelaProdutosBody: document.querySelector('#tabela-analise-produtos tbody'),
        paginacaoContainer: document.getElementById('paginacaoContainerProdutos'),
        loadingOverlay: document.getElementById('loadingOverlay')
    };
    
    // --- VARIÁVEIS GLOBAIS ---
    // Variáveis para armazenar as instâncias dos gráficos Chart.js.
    let chartABC, chartTopReceita, chartTopQtd;
    
    // Constante para definir a quantidade de itens por página na tabela.
    const ITENS_POR_PAGINA = 50;
    // Variável de estado para controlar a página atual da tabela.
    let paginaAtualProdutos = 1;
    // Array para armazenar todos os produtos recebidos da API, para permitir a paginação no lado do cliente.
    let todosOsProdutos = [];

    /**
     * Função auxiliar para formatar um valor numérico como moeda brasileira (BRL).
     * @param {number} valor - O número a ser formatado.
     * @returns {string} A string formatada, ex: "R$ 1.234,56".
     */
    const formatarMoeda = (valor) => {
        return (valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    };

    /**
     * Função assíncrona principal que busca os dados da API e coordena a renderização da página.
     */
    async function carregarDadosProdutos() {
        // Exibe o overlay de carregamento.
        elements.loadingOverlay.style.display = 'flex';
        
        // Obtém as datas dos filtros globais.
        const dataInicio = document.getElementById('dataInicio').value;
        const dataFim = document.getElementById('dataFim').value;
        
        // Constrói a URL da API com os parâmetros de data.
        const url = `/api/dados-produtos-estoque?dataInicio=${dataInicio}&dataFim=${dataFim}`;

        try {
            // Realiza a requisição à API.
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Erro na requisição: ${response.statusText}`);
            
            // Converte a resposta em JSON.
            const data = await response.json();

            // Verifica se não há dados ou se a tabela de produtos está vazia.
            if (!data || !data.tabela_produtos || data.tabela_produtos.length === 0) {
                // Se não houver dados, esconde o conteúdo principal e mostra a mensagem de "vazio".
                elements.mainContent.style.display = 'none';
                elements.emptyState.style.display = 'flex';
            } else {
                // Se houver dados, exibe o conteúdo e esconde a mensagem de "vazio".
                elements.mainContent.style.display = 'block';
                elements.emptyState.style.display = 'none';

                // Chama as funções para atualizar cada parte da página com os novos dados.
                atualizarCards(data.indicadores);
                renderizarGraficoABC(data.curva_abc);
                renderizarGraficosTop(data.graficos_top);
                
                // AJUSTE: Ordena a lista de produtos pela quantidade vendida (do maior para o menor) antes de armazenar.
                todosOsProdutos = data.tabela_produtos.sort((a, b) => b.qtd_vendida - a.qtd_vendida);
                paginaAtualProdutos = 1;

                // Renderiza a tabela com a primeira página de dados já ordenados.
                renderizarTabelaPaginada();
            }

        } catch (error) {
            // Em caso de erro, exibe no console e mostra a tela de "vazio".
            console.error("Falha ao carregar dados de produtos e estoque:", error);
            elements.mainContent.style.display = 'none';
            elements.emptyState.style.display = 'flex';
        } finally {
            // Garante que o overlay de carregamento seja escondido ao final da operação.
            elements.loadingOverlay.style.display = 'none';
        }
    }

    /**
     * Atualiza os valores nos cards de indicadores na parte superior da página.
     * @param {object} indicadores - Objeto contendo os KPIs de produtos e estoque.
     */
    function atualizarCards(indicadores) {
        elements.cardProdutosAtivos.textContent = (indicadores.produtos_ativos || 0).toLocaleString('pt-BR');
        elements.cardProdutosSemVenda.textContent = (indicadores.produtos_sem_venda || 0).toLocaleString('pt-BR');
        elements.cardValorEstoque.textContent = formatarMoeda(indicadores.valor_estoque_custo);
        elements.cardEstoqueCritico.textContent = (indicadores.estoque_critico || 0).toLocaleString('pt-BR');
        elements.cardEstoqueBaixo.textContent = (indicadores.estoque_baixo || 0).toLocaleString('pt-BR');
        elements.cardEstoqueAceitavel.textContent = (indicadores.estoque_aceitavel || 0).toLocaleString('pt-BR');
        elements.cardEstoqueOtimo.textContent = (indicadores.estoque_otimo || 0).toLocaleString('pt-BR');
    }

    /**
     * Renderiza o gráfico de Curva ABC (tipo rosca).
     * Destrói qualquer instância anterior do gráfico para evitar problemas de renderização.
     * @param {object} dados - Objeto com 'labels' e 'data' para o gráfico.
     */
    function renderizarGraficoABC(dados) {
        const ctx = document.getElementById('graficoCurvaABC').getContext('2d');
        // Se já existe um gráfico, destrói-o antes de criar um novo.
        if (chartABC) chartABC.destroy();
        chartABC = new Chart(ctx, { type: 'doughnut', data: { labels: dados.labels, datasets: [{ label: 'Nº de Produtos por Categoria', data: dados.data, backgroundColor: ['#2ecc71', '#3498db', '#f1c40f'], hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } } });
    }

    /**
     * Renderiza os gráficos de Top 10 produtos por receita e por quantidade (barras horizontais).
     * @param {object} dados - Objeto contendo os dados para ambos os gráficos 'top_receita' e 'top_qtd'.
     */
    function renderizarGraficosTop(dados) {
        // Renderiza o gráfico de Top 10 por Receita.
        const ctxReceita = document.getElementById('graficoTopReceita').getContext('2d');
        if (chartTopReceita) chartTopReceita.destroy();
        chartTopReceita = new Chart(ctxReceita, { type: 'bar', data: { labels: dados.top_receita.labels, datasets: [{ label: 'Receita (R$)', data: dados.top_receita.data, backgroundColor: '#1a3b5d', }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, interaction: {mode: 'index', intersect: false, axis: 'y'} } });
        
        // Renderiza o gráfico de Top 10 por Quantidade.
        const ctxQtd = document.getElementById('graficoTopQtd').getContext('2d');
        if (chartTopQtd) chartTopQtd.destroy();
        chartTopQtd = new Chart(ctxQtd, { type: 'bar', data: { labels: dados.top_qtd.labels, datasets: [{ label: 'Quantidade Vendida', data: dados.top_qtd.data, backgroundColor: '#2c537e', }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, interaction: {mode: 'index', intersect: false, axis: 'y'} } });
    }

    /**
     * Controla a renderização da tabela, fatiando os dados da página atual e chamando as funções de renderização.
     */
    function renderizarTabelaPaginada() {
        // Calcula os índices de início e fim para os dados da página atual.
        const inicio = (paginaAtualProdutos - 1) * ITENS_POR_PAGINA;
        const fim = inicio + ITENS_POR_PAGINA;
        const dadosDaPagina = todosOsProdutos.slice(inicio, fim);

        // Chama a função para renderizar as linhas da tabela.
        renderizarTabelaProdutos(dadosDaPagina);
        // Gera e insere o HTML dos controles de paginação.
        elements.paginacaoContainer.innerHTML = criarControlesPaginacao();
    }

    /**
     * Gera e insere o HTML para as linhas do corpo da tabela de produtos.
     * @param {Array} produtosDaPagina - Array com os objetos de produto para a página atual.
     */
    function renderizarTabelaProdutos(produtosDaPagina) {
        // Se não houver produtos para a página, exibe uma mensagem na tabela.
        if (produtosDaPagina.length === 0) {
            elements.tabelaProdutosBody.innerHTML = '<tr><td colspan="8">Nenhum dado de venda encontrado para o período.</td></tr>';
            return;
        }

        // Constrói a string HTML para todas as linhas da tabela.
        let tableHTML = '';
        produtosDaPagina.forEach(p => {
            tableHTML += `
                <tr>
                    <td>${p.nome}</td>
                    <td>${(p.qtd_vendida || 0).toLocaleString('pt-BR')}</td>
                    <td>${formatarMoeda(p.receita_gerada)}</td>
                    <td>${formatarMoeda(p.custo_total)}</td>
                    <td>${formatarMoeda(p.lucro_bruto)}</td>
                    <td>${(p.margem_percentual || 0).toFixed(2)}%</td>
                    <td>${(p.quantidadeEstoque || 0).toLocaleString('pt-BR')}</td>
                    <td>${(p.giro_estoque || 0).toFixed(2)}</td>
                </tr>
            `;
        });
        
        // Insere o HTML gerado no corpo da tabela.
        elements.tabelaProdutosBody.innerHTML = tableHTML;
    }

    /**
     * Gera o HTML para os botões de controle da paginação.
     * @returns {string} O HTML dos controles de paginação.
     */
    function criarControlesPaginacao() {
        const totalPaginas = Math.ceil(todosOsProdutos.length / ITENS_POR_PAGINA);
        if (totalPaginas <= 1) return ''; // Não mostra paginação se houver apenas uma página.

        // Botão "Anterior".
        let html = `<button class="paginacao-btn" data-pagina="${paginaAtualProdutos - 1}" ${paginaAtualProdutos === 1 ? 'disabled' : ''}>&laquo; Anterior</button>`;
        
        // Lógica para renderizar os números das páginas, incluindo "..." para longas listas.
        for (let i = 1; i <= totalPaginas; i++) {
             if (i === 1 || i === totalPaginas || (i >= paginaAtualProdutos - 2 && i <= paginaAtualProdutos + 2)) {
                html += `<button class="paginacao-btn ${i === paginaAtualProdutos ? 'active' : ''}" data-pagina="${i}">${i}</button>`;
             } else if (i === paginaAtualProdutos - 3 || i === paginaAtualProdutos + 3) {
                html += `<span>...</span>`;
             }
        }
        
        // Botão "Próximo".
        html += `<button class="paginacao-btn" data-pagina="${paginaAtualProdutos + 1}" ${paginaAtualProdutos === totalPaginas ? 'disabled' : ''}>Próximo &raquo;</button>`;
        return html;
    }

    /**
     * Manipulador de eventos para os cliques nos botões de paginação.
     * @param {Event} event - O objeto do evento de clique.
     */
    function handlePaginacaoClick(event) {
        const target = event.target.closest('.paginacao-btn');
        if (!target || target.disabled) return; // Ignora cliques inválidos.

        // Atualiza a página atual e re-renderiza a tabela.
        paginaAtualProdutos = parseInt(target.dataset.pagina, 10);
        renderizarTabelaPaginada();
    }
    
    // --- INICIALIZAÇÃO ---
    // Adiciona o ouvinte de evento ao container da paginação (usando delegação de eventos).
    elements.paginacaoContainer.addEventListener('click', handlePaginacaoClick);

    // Chama a função de carregamento de dados pela primeira vez ao carregar a página.
    carregarDadosProdutos();
});
</script>
{% endblock %}