{% extends "layout.html" %}


{% block title %}Análise de Vendas{% endblock %}

{% block page_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/analise_vendas.css') }}">
{% endblock %}

{% block content %}
<div id="mainContent" style="display: none;">
    <div class="resumo-container" id="resumoContainer"></div>
    
    <div class="graficos-grid-analise" id="graficosContainerAnalise" style="display: none;">
        <div class="grafico-container-analise">
            <h3>Vendas por Vendedor (R$)</h3>
            <canvas id="vendasPorVendedorChart"></canvas>
        </div>
        <div class="grafico-container-analise">
            <h3>Vendas por Hora do Dia (R$)</h3>
            <canvas id="vendasPorHoraChart"></canvas>
        </div>
        <div class="grafico-container-analise">
            <h3>Vendas por Forma de Pagamento (R$)</h3>
            <canvas id="vendasPorPagamentoChart"></canvas>
        </div>
         <div class="grafico-container-analise">
            <h3>Vendas por Tipo de Entrega (R$)</h3>
            <canvas id="vendasPorEntregaChart"></canvas>
        </div>
    </div>
    <h2>NOTAS EMITIDAS</h2>
    <div class="table-wrapper" id="tabelaContainerPrincipais"></div>
    <div class="paginacao-container" id="paginacaoContainerPrincipais"></div>
    
    <h2>NOTAS EXCLUÍDAS (PARA CONFERÊNCIA)</h2>
    <div class="table-wrapper" id="tabelaContainerExcluidas"></div>
    <div class="paginacao-container" id="paginacaoContainerExcluidas"></div>
</div>
<div id="emptyState" style="display: none;">
    <div class="icon">
        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z" fill="#5dade2"/>
        </svg>
    </div>
    <h2>Nenhum dado encontrado</h2>
    <p>Não há registros de vendas para exibir.</p>
</div>
{% endblock %}


{% block scripts %}
<script>
    // --- DECLARAÇÃO DE VARIÁVEIS GLOBAIS E REFERÊNCIAS DE ELEMENTOS ---

    // Referências aos principais elementos da interface (DOM).
    const loadingOverlay = document.getElementById('loadingOverlay');
    const mainContent = document.getElementById('mainContent');
    const emptyState = document.getElementById('emptyState');
    const pageContainer = document.querySelector('.container');
    const resumoContainer = document.getElementById('resumoContainer');
    const tabelaContainerPrincipais = document.getElementById('tabelaContainerPrincipais');
    const tabelaContainerExcluidas = document.getElementById('tabelaContainerExcluidas');
    
    // Constante que define o número de itens a serem exibidos por página nas tabelas.
    const ITENS_POR_PAGINA = 50;
    
    // Variáveis de estado para controlar a paginação das tabelas.
    let paginaAtualPrincipais = 1;
    let paginaAtualExcluidas = 1;

    // Arrays para armazenar os dados filtrados que serão exibidos nas tabelas.
    let notasPrincipaisFiltradas = [];
    let notasExcluidasFiltradas = [];

    // Variáveis para armazenar os dados processados e os cabeçalhos das tabelas.
    let dadosAgrupados = {};
    let cabecalhoVenda = [];
    let cabecalhoItem = [];
    
    // Mapeamento de chaves de dados para nomes de colunas amigáveis na interface.
    const mapeamentoColunas = {
        "numeroNota": "Nº Cupom", "dataEmissao": "Data", "horaEmissao": "Hora",
        "codigoVendedor": "Nº Vend", "nomeVendedor": "Vendedor", "codigoCliente": "Cód. Cliente",
        "entrega": "Entrega", "condicaoPagamento_nome": "Cond. Pagamento", "parceiro": "Parceiro",
        "numeroNotaFiscal": "Nº Nota", "status_venda": "Status", "numeroNotaOrigem": "Nota Origem",
        "Total Custo": "Total Custo", "Total Bruto": "Total Bruto", "Total Líquido": "Total Líquido",
        "codigoProduto": "Cód. Produto", "nome": "Descrição Produto", "quantidadeProdutos": "Qtd",
        "valorTotalCusto": "Vlr. Custo", "valorTotalBruto": "Vlr. Bruto", "valorTotalLiquido": "Vlr. Líquido"
    };

    /**
     * Função principal que inicia a renderização do dashboard.
     * Verifica se há dados de vendas. Se houver, processa e exibe os dados.
     * Caso contrário, exibe um estado de "nenhum dado encontrado".
     * @param {object} dados - O objeto de dados recebido da API.
     */
    function iniciarDashboard(dados) {
        // Extrai os dados necessários do objeto principal.
        const { sales_data, vendas_por_pagamento, vendas_por_hora, vendas_por_vendedor, vendas_por_entrega } = dados;

        // Verifica se a lista de dados de vendas está vazia ou não existe.
        if (!sales_data || sales_data.length === 0) {
            // Esconde o conteúdo principal e exibe a mensagem de "vazio".
            mainContent.style.display = 'none';
            emptyState.style.display = 'flex';
            // Ajusta a largura do container para centralizar a mensagem.
            if (pageContainer) pageContainer.style.maxWidth = '60%';
        } else {
            // Se houver dados, exibe o conteúdo principal e esconde a mensagem de "vazio".
            emptyState.style.display = 'none';
            mainContent.style.display = 'block';
            // Restaura a largura total do container.
            if (pageContainer) pageContainer.style.maxWidth = '100%';
            
            // Chama as funções para processar os dados, renderizar os gráficos e atualizar o dashboard.
            processarDados(sales_data);
            renderizarGraficos(vendas_por_pagamento, vendas_por_hora, vendas_por_vendedor, vendas_por_entrega);
            atualizarDashboard(dadosAgrupados);
        }
    }

    /**
     * Renderiza os gráficos do dashboard usando Chart.js.
     * Destrói instâncias antigas de gráficos antes de criar novas para evitar problemas de memória.
     * @param {object} dadosPagamento - Dados para o gráfico de formas de pagamento.
     * @param {object} dadosHora - Dados para o gráfico de vendas por hora.
     * @param {object} dadosVendedor - Dados para o gráfico de vendas por vendedor.
     * @param {object} dadosEntrega - Dados para o gráfico de vendas por tipo de entrega.
     */
    function renderizarGraficos(dadosPagamento, dadosHora, dadosVendedor, dadosEntrega) {
        const graficosContainer = document.getElementById('graficosContainerAnalise');

        // Itera sobre os IDs dos canvas dos gráficos para destruir instâncias existentes.
        ['vendasPorPagamentoChart', 'vendasPorHoraChart', 'vendasPorVendedorChart', 'vendasPorEntregaChart'].forEach(id => {
            const chartInstance = Chart.getChart(id);
            if (chartInstance) chartInstance.destroy();
        });
        
        // Verifica se há dados válidos para cada um dos gráficos.
        const hasPagamentoData = dadosPagamento && Object.keys(dadosPagamento).length > 0;
        const hasHoraData = dadosHora && Object.values(dadosHora).some(v => v > 0);
        const hasVendedorData = dadosVendedor && Object.keys(dadosVendedor).length > 0;
        const hasEntregaData = dadosEntrega && Object.keys(dadosEntrega).length > 0;

        // Se nenhum gráfico tiver dados, esconde o container de gráficos.
        if (!hasPagamentoData && !hasHoraData && !hasVendedorData && !hasEntregaData) {
            graficosContainer.style.display = 'none';
            return;
        }
        
        // Exibe o container de gráficos se houver dados para pelo menos um.
        graficosContainer.style.display = 'grid';

        // Função auxiliar para gerar cores aleatórias para os gráficos.
        const getRandomColor = () => `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 0.7)`;

        // Renderiza o gráfico de Vendas por Vendedor (tipo pizza).
        if (hasVendedorData) {
            const ctx = document.getElementById('vendasPorVendedorChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(dadosVendedor),
                    datasets: [{
                        data: Object.values(dadosVendedor),
                        backgroundColor: Object.keys(dadosVendedor).map(() => getRandomColor()),
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
        
        // Renderiza o gráfico de Vendas por Hora (tipo barra).
        if (hasHoraData) {
            const ctx = document.getElementById('vendasPorHoraChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(dadosHora).map(h => `${h}h`),
                    datasets: [{
                        label: 'Valor de Vendas (R$)',
                        data: Object.values(dadosHora),
                        backgroundColor: '#3498db',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // Renderiza o gráfico de Vendas por Pagamento (tipo rosca).
        if (hasPagamentoData) {
            const ctx = document.getElementById('vendasPorPagamentoChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(dadosPagamento),
                    datasets: [{
                        data: Object.values(dadosPagamento),
                        backgroundColor: Object.keys(dadosPagamento).map(() => getRandomColor()),
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // Renderiza o gráfico de Vendas por Entrega (tipo pizza).
        if (hasEntregaData) {
            const ctx = document.getElementById('vendasPorEntregaChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(dadosEntrega),
                    datasets: [{
                        data: Object.values(dadosEntrega),
                        backgroundColor: ['#2ecc71', '#e74c3c', '#f1c40f'],
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    }
    
    /**
     * Processa os dados brutos (planos) da API e os agrupa por nota fiscal.
     * Transforma uma lista de itens de venda em um objeto estruturado, onde cada chave é um número de nota.
     * @param {Array} dadosPlanos - Array de objetos, onde cada objeto é um item de uma venda.
     */
    function processarDados(dadosPlanos) {
        dadosAgrupados = {}; // Limpa dados antigos.
        if (!dadosPlanos || dadosPlanos.length === 0) return;

        // Define quais colunas pertencem à informação geral da venda.
        const colunasInfoVenda = ["numeroNota", "dataEmissao", "horaEmissao", "codigoVendedor", "nomeVendedor", "codigoCliente", "entrega", "condicaoPagamento_nome", "numeroNotaFiscal", "status_venda", "numeroNotaOrigem"];
        // Define as colunas que serão exibidas no cabeçalho da tabela de vendas.
        const colunasDisplayVenda = ["numeroNota", "dataEmissao", "horaEmissao", "codigoVendedor", "codigoCliente", "entrega", "condicaoPagamento_nome", "numeroNotaFiscal", "status_venda"];
        
        // Define o cabeçalho para a sub-tabela de itens.
        cabecalhoItem = ["codigoProduto", "nome", "quantidadeProdutos", "valorTotalCusto", "valorTotalBruto", "valorTotalLiquido"];
        // Define o cabeçalho final da tabela principal de vendas, incluindo os totais.
        cabecalhoVenda = [...colunasDisplayVenda, "Total Custo", "Total Bruto", "Total Líquido"];
        
        // Itera sobre cada linha (item de venda) dos dados recebidos.
        dadosPlanos.forEach(linha => {
            const notaId = linha.numeroNota;
            // Se a nota ainda não foi processada, cria a estrutura base para ela.
            if (!dadosAgrupados [notaId]) {
                dadosAgrupados [notaId] = { info: {}, itens: [], totais: { bruto: 0, liquido: 0, custo: 0 }};
                // Preenche as informações gerais da venda.
                colunasInfoVenda.forEach(col => dadosAgrupados [notaId].info [col] = linha [col]);
            }
            // Cria um objeto para o item atual e o adiciona à lista de itens da nota.
            const item = {};
            cabecalhoItem.forEach(col => item [col] = linha [col]);
            dadosAgrupados [notaId].itens.push(item);

            // Acumula os totais da nota com base nos valores do item atual.
            dadosAgrupados [notaId].totais.bruto += parseFloat(linha.valorTotalBruto || 0);
            dadosAgrupados [notaId].totais.liquido += parseFloat(linha.valorTotalLiquido || 0);
            dadosAgrupados [notaId].totais.custo += parseFloat(linha.valorTotalCusto || 0);
        });
    }
    
    /**
     * Atualiza os cards de resumo e prepara os dados para as tabelas de notas.
     * Separa as vendas em "principais" (OK, Devolução) e "excluídas".
     * @param {object} dadosParaExibir - Objeto com os dados de vendas já agrupados por nota.
     */
    function atualizarDashboard(dadosParaExibir) {
        const vendas = Object.values(dadosParaExibir);
        // Se não houver vendas, exibe uma mensagem e limpa as tabelas.
        if (vendas.length === 0) {
            resumoContainer.innerHTML = "<p style='text-align:center;'>Nenhum registro encontrado para o filtro aplicado.</p>";
            tabelaContainerPrincipais.innerHTML = "";
            tabelaContainerExcluidas.innerHTML = "";
            document.getElementById('paginacaoContainerPrincipais').innerHTML = "";
            document.getElementById('paginacaoContainerExcluidas').innerHTML = "";
            return;
        }

        // Filtra as notas por status.
        notasPrincipaisFiltradas = vendas.filter(v => v.info.status_venda !== 'Excluída');
        notasExcluidasFiltradas = vendas.filter(v => v.info.status_venda === 'Excluída');
        
        // Variáveis para calcular os totais dos cards de resumo.
        let countEmitidas = 0, countDevolvidas = 0;
        let somaBruto = 0, somaLiquido = 0, somaCusto = 0;

        // Itera sobre as notas principais para calcular os totais.
        notasPrincipaisFiltradas.forEach(({ info, totais }) => {
            if (info.status_venda === 'OK') countEmitidas++;
            else if (info.status_venda === 'DEVOLUÇÃO') countDevolvidas++;
            somaBruto += totais.bruto;
            somaLiquido += totais.liquido;
            somaCusto += totais.custo;
        });
        const somaLucro = somaLiquido - somaCusto;
        const totalTransacoes = vendas.length;
        
        // Atualiza o HTML do container de resumo com os valores calculados.
        resumoContainer.innerHTML = `
            <div class="resumo-card emitidas"><h4>NOTAS VENDAS</h4><p>${countEmitidas}</p></div>
            <div class="resumo-card excluidas"><h4>NOTAS VENDAS EXCLUÍDAS</h4><p>${notasExcluidasFiltradas.length}</p></div>
            <div class="resumo-card devolvidas"><h4>NOTAS DEVOLUÇÃO</h4><p>${countDevolvidas}</p></div>
            <div class="resumo-card custo"><h4>VALOR CUSTO</h4><p>${somaCusto.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p></div>
            <div class="resumo-card bruto"><h4>VALOR BRUTO</h4><p>${somaBruto.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p></div>
            <div class="resumo-card liquido"><h4>VALOR LIQUIDO</h4><p>${somaLiquido.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p></div>
            <div class="resumo-card totais"><h4>TOTAL NOTAS EMITIDAS</h4><p>${totalTransacoes}</p></div>
            <div class="resumo-card lucro">
                <h4>
                    LUCRO BRUTO DAS VENDAS
                    <div class="tooltip-container">
                        <span class="info-icon">i</span>
                        <div class="tooltip-text">
                            Os valores de Custo e Lucro Bruto referem-se estritamente ao Custo dos Produtos Vendidos (CPV), não incluindo despesas operacionais como aluguel, salários e custos administrativos.
                        </div>
                    </div>
                </h4>
                <p>${somaLucro.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
            </div>
        `;

        // Reseta a paginação para a primeira página.
        paginaAtualPrincipais = 1;
        paginaAtualExcluidas = 1;

        // Renderiza as tabelas com os dados processados.
        renderizarTabelaPaginada('principais');
        renderizarTabelaPaginada('excluidas');
    }

    /**
     * Controla a renderização das tabelas com base na paginação.
     * @param {string} tipo - 'principais' ou 'excluidas', para identificar qual tabela renderizar.
     */
    function renderizarTabelaPaginada(tipo) {
        const ehPrincipal = tipo === 'principais';
        const dadosCompletos = ehPrincipal ? notasPrincipaisFiltradas : notasExcluidasFiltradas;
        const paginaAtual = ehPrincipal ? paginaAtualPrincipais : paginaAtualExcluidas;
        const containerTabela = ehPrincipal ? tabelaContainerPrincipais : tabelaContainerExcluidas;
        const containerPaginacao = document.getElementById(ehPrincipal ? 'paginacaoContainerPrincipais' : 'paginacaoContainerExcluidas');

        // Calcula os índices de início e fim para fatiar os dados da página atual.
        const inicio = (paginaAtual - 1) * ITENS_POR_PAGINA;
        const fim = inicio + ITENS_POR_PAGINA;
        const dadosDaPagina = dadosCompletos.slice(inicio, fim);
        
        // Calcula os totais gerais para o rodapé da tabela.
        const totais = dadosCompletos.reduce((acc, { totais }) => {
            acc.custo += totais.custo;
            acc.bruto += totais.bruto;
            acc.liquido += totais.liquido;
            return acc;
        }, { custo: 0, bruto: 0, liquido: 0 });

        // Gera e insere o HTML da tabela e dos controles de paginação.
        containerTabela.innerHTML = criarHtmlDeTabela(dadosDaPagina, totais);
        containerPaginacao.innerHTML = criarControlesPaginacao(dadosCompletos.length, paginaAtual, tipo);
    }

    /**
     * Gera o HTML para os botões de controle da paginação.
     * @param {number} totalItens - O número total de itens na lista.
     * @param {number} paginaAtual - O número da página atual.
     * @param {string} tipo - O tipo da tabela ('principais' ou 'excluidas').
     * @returns {string} O HTML dos controles de paginação.
     */
    function criarControlesPaginacao(totalItens, paginaAtual, tipo) {
        const totalPaginas = Math.ceil(totalItens / ITENS_POR_PAGINA);
        if (totalPaginas <= 1) return ''; // Não mostra paginação se houver apenas uma página.

        let html = '';
        // Botão "Anterior".
        html += `<button class="paginacao-btn" data-tipo="${tipo}" data-pagina="${paginaAtual - 1}" ${paginaAtual === 1 ? 'disabled' : ''}>&laquo; Anterior</button>`;

        // Lógica para renderizar os números das páginas, incluindo "..." para longas listas.
        for (let i = 1; i <= totalPaginas; i++) {
             if (i === 1 || i === totalPaginas || (i >= paginaAtual - 2 && i <= paginaAtual + 2)) {
                html += `<button class="paginacao-btn ${i === paginaAtual ? 'active' : ''}" data-tipo="${tipo}" data-pagina="${i}">${i}</button>`;
             } else if (i === paginaAtual - 3 || i === paginaAtual + 3) {
                html += `<span>...</span>`;
             }
        }
        
        // Botão "Próximo".
        html += `<button class="paginacao-btn" data-tipo="${tipo}" data-pagina="${paginaAtual + 1}" ${paginaAtual === totalPaginas ? 'disabled' : ''}>Próximo &raquo;</button>`;
        
        return html;
    }

    /**
     * Manipulador de eventos para os cliques nos botões de paginação.
     * @param {Event} event - O objeto do evento de clique.
     */
    function handlePaginacaoClick(event) {
        // Encontra o botão de paginação que foi clicado.
        const target = event.target.closest('.paginacao-btn');
        if (!target || target.disabled) return; // Ignora cliques fora de botões ou em botões desabilitados.

        // Obtém o tipo e o número da nova página a partir dos atributos de dados do botão.
        const tipo = target.dataset.tipo;
        const novaPagina = parseInt(target.dataset.pagina, 10);

        // Atualiza a variável de estado da página atual correspondente.
        if (tipo === 'principais') {
            paginaAtualPrincipais = novaPagina;
        } else if (tipo === 'excluidas') {
            paginaAtualExcluidas = novaPagina;
        }

        // Re-renderiza a tabela para a nova página.
        renderizarTabelaPaginada(tipo);
    }

    /**
     * Gera o HTML completo para uma tabela de vendas, incluindo cabeçalho, corpo e rodapé de totais.
     * @param {Array} dados - Array de dados de vendas para a página atual.
     * @param {object} totais - Objeto contendo os totais de custo, bruto e líquido para o rodapé.
     * @returns {string} O HTML da tabela.
     */
    function criarHtmlDeTabela(dados, totais) {
        if (dados.length === 0) return "<p style='text-align:center;'>Nenhuma nota nesta categoria.</p>";
        
        // Inicia a construção da string HTML da tabela.
        let tableHTML = '<table><thead><tr>';
        // Cria os cabeçalhos da tabela principal.
        cabecalhoVenda.forEach(key => tableHTML += `<th>${mapeamentoColunas [key] || key}</th>`);
        tableHTML += '</tr></thead><tbody>';

        // Itera sobre cada venda para criar as linhas da tabela.
        dados.forEach(({ info, itens, totais: totaisLinha }, index) => {
            // Define classes CSS com base no status da venda para estilização.
            const statusNormalized = (info.status_venda || 'ok').toLowerCase().replace(' ', '-').normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            const statusClass = `status-${statusNormalized}`;
            // Classe para zebrar as linhas da tabela (alternar cores).
            const zebraClass = index % 2 === 0 ? 'linha-branca' : 'linha-cinza';

            // Cria a linha principal da venda.
            tableHTML += `<tr class="linha-venda ${statusClass} ${zebraClass}" data-nota-id="${info.numeroNota}">`;
            cabecalhoVenda.forEach(col => {
                let valor = ''; let classe = '';
                if (info [col] !== undefined) {
                    // Formatação especial para data.
                    if (col === 'dataEmissao') {
                        const dataCrua = info [col];
                        const partes = dataCrua.split('-');
                        if (partes.length === 3) valor = `${partes [2]}/${partes [1]}/${partes [0]}`;
                        else valor = dataCrua || '';
                    // Formatação especial para hora.
                    } else if (col === 'horaEmissao' && typeof info [col] === 'string') {
                        valor = info [col].substring(0, 8);
                    // Formatação especial para status.
                    } else if (col === 'status_venda') {
                        const status = info [col];
                        if (status === 'DEVOLUÇÃO') valor = 'DEV';
                        else if (status === 'Excluída') valor = 'EXCL';
                        else valor = status || '';
                    } else {
                        valor = info [col] || '';
                    }
                    if (col === 'numeroNota') classe = 'nota-clicavel';
                } else {
                    // Preenche as colunas de totais da linha.
                    classe = 'col-numerica';
                    if (col === 'Total Custo') valor = totaisLinha.custo.toFixed(2);
                    else if (col === 'Total Bruto') valor = totaisLinha.bruto.toFixed(2);
                    else if (col === 'Total Líquido') valor = totaisLinha.liquido.toFixed(2);
                }
                tableHTML += `<td class="${classe}">${valor}</td>`;
            });
            tableHTML += `</tr>`;
            
            // Cria a linha oculta com os detalhes dos itens da venda.
            const cabecalhoItensOrdenado = ["codigoProduto", "nome", "quantidadeProdutos", "valorTotalCusto", "valorTotalBruto", "valorTotalLiquido"];
            let detalhesHTML = '<div class="tabela-interna"><table><thead><tr>';

            // Adiciona informação da nota de origem para devoluções.
            if (info.status_venda === 'DEVOLUÇÃO') {
                detalhesHTML = `
                    <div class="detalhe-adicional" style="padding: 10px; font-weight: bold; background-color: #fef4f4; border-radius: 4px; border: 1px dashed #e74c3c;">
                        Nota Origem: ${info.numeroNotaOrigem || 'Não informada'}
                    </div>
                ` + detalhesHTML;
            }
            
            // Cria os cabeçalhos da sub-tabela de itens.
            cabecalhoItensOrdenado.forEach(key => detalhesHTML += `<th>${mapeamentoColunas [key] || key}</th>`);
            detalhesHTML += '</tr></thead><tbody>';
            // Cria as linhas para cada item da venda.
            itens.forEach(item => {
                detalhesHTML += '<tr>';
                cabecalhoItensOrdenado.forEach(col => {
                    const tdClass = col === 'nome' ? 'col-descricao' : '';
                    detalhesHTML += `<td class="${tdClass}">${item [col] || ''}</td>`;
                });
                detalhesHTML += '</tr>';
            });
            detalhesHTML += '</tbody></table></div>';
            
            // Adiciona a linha de detalhes, que ficará oculta por padrão.
            tableHTML += `<tr class="detalhes-produtos ${zebraClass}"><td colspan="${cabecalhoVenda.length}">${detalhesHTML}</td></tr>`;
        });
        tableHTML += '</tbody>';

        // Adiciona o rodapé com os totais gerais do período.
        if(totais) {
            const colspan = cabecalhoVenda.length - 3;
            tableHTML += `
                <tfoot>
                    <tr>
                        <td colspan="${colspan}"><strong>TOTAIS DO PERÍODO</strong></td>
                        <td class="col-numerica">${totais.custo.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="col-numerica">${totais.bruto.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="col-numerica">${totais.liquido.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    </tr>
                </tfoot>
            `;
        }
        tableHTML += '</table>';
        return tableHTML;
    }
    
    /**
     * Manipulador de eventos para expandir/recolher os detalhes dos itens de uma venda.
     * @param {Event} event - O objeto do evento de clique.
     */
    function toggleDetails(event) {
        // Encontra a linha principal da venda que foi clicada.
        const linhaVenda = event.target.closest('.linha-venda');
        if (linhaVenda) {
            // Encontra a próxima linha, que contém os detalhes dos produtos.
            const detalhesRow = linhaVenda.nextElementSibling;
            if (detalhesRow && detalhesRow.classList.contains('detalhes-produtos')) {
                // Alterna a classe que indica se a linha está expandida.
                linhaVenda.classList.toggle('linha-expandida');
                // Alterna a visibilidade da linha de detalhes.
                detalhesRow.style.display = detalhesRow.style.display === 'table-row' ? 'none' : 'table-row';
            }
        }
    }
    
    /**
     * Função assíncrona para buscar os dados da API e iniciar a atualização do dashboard.
     * É chamada quando a página carrega ou quando os filtros são aplicados.
     */
    async function fetchAndUpdateAnaliseVendas() {
        loadingOverlay.style.display = 'flex'; // Mostra o indicador de carregamento.

        // Obtém as datas dos filtros globais.
        const dataInicio = document.getElementById('dataInicio').value;
        const dataFim = document.getElementById('dataFim').value;

        // Constrói a URL da API com os parâmetros de data.
        const url = new URL('/api/dados-dashboard', window.location.origin);
        url.searchParams.set('dataInicio', dataInicio);
        url.searchParams.set('dataFim', dataFim);

        try {
            // Realiza a requisição para a API.
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error('Erro na rede ao buscar dados para análise de vendas');
            }
            
            // Converte a resposta para JSON.
            const dados = await response.json();

            // Inicia o processo de renderização do dashboard com os dados recebidos.
            iniciarDashboard(dados);

        } catch (error) {
            // Em caso de erro, exibe no console e mostra o estado de "vazio".
            console.error("Falha ao buscar dados para a análise de vendas:", error);
            mainContent.style.display = 'none';
            emptyState.style.display = 'flex';
        } finally {
            // Garante que o indicador de carregamento seja escondido ao final, com ou sem erro.
            loadingOverlay.style.display = 'none';
        }
    }

    // --- EVENT LISTENERS ---

    // Executa o código quando o conteúdo do DOM estiver completamente carregado.
    document.addEventListener('DOMContentLoaded', () => {
        // Adiciona ouvintes de eventos de clique nas tabelas para a funcionalidade de expandir/recolher.
        tabelaContainerPrincipais.addEventListener('click', toggleDetails);
        tabelaContainerExcluidas.addEventListener('click', toggleDetails);

        // Adiciona um ouvinte de evento de clique no corpo do documento para a paginação (delegação de evento).
        const contentBody = document.querySelector('body');
        if(contentBody) {
             contentBody.addEventListener('click', handlePaginacaoClick);
        }

        // Realiza a primeira busca de dados ao carregar a página.
        fetchAndUpdateAnaliseVendas();
    });
</script>
{% endblock %}